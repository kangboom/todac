name: Backend Auto Deploy (FastAPI + DBs)

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: Checkout Code
        uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 2. Docker Hub ë¡œê·¸ì¸
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 3. FastAPI ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      # (DBë‚˜ MilvusëŠ” ê³µì‹ ì´ë¯¸ì§€ë¥¼ ì“°ë¯€ë¡œ ë¹Œë“œí•  í•„ìš” ì—†ìŒ)
      - name: Build and Push Backend Image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          # â˜… docker-compose.ymlì— ì ì€ image ì´ë¦„ê³¼ ë˜‘ê°™ì´!
          tags: ${{ secrets.DOCKER_USERNAME }}/todac-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      # 4. docker-compose.yml íŒŒì¼ ì„œë²„ë¡œ ë°°ë‹¬
      - name: Copy docker-compose to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          source: "docker-compose.yml"
          target: "~/backend" # ë°±ì—”ë“œ ì „ìš© í´ë”

      # 5. ì„œë²„ ì ‘ì† ë° ë°°í¬ ì‹¤í–‰
      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          timeout: 40s           # ì„œë²„ ì ‘ì† ì‹œë„ ëŒ€ê¸° ì‹œê°„ (ê¸°ë³¸ 30s)
          command_timeout: 30m   # ëª…ë ¹ì–´ ì‹¤í–‰ ëŒ€ê¸° ì‹œê°„ (ë„‰ë„‰í•˜ê²Œ 30ë¶„!)

          script: |
            echo "ğŸš§ ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ë°°í¬ ì‹œì‘..."
            
            # í´ë” ìƒì„± ë° ì´ë™
            mkdir -p ~/backend
            cd ~/backend
            
            # 1. í™˜ê²½ë³€ìˆ˜ íŒŒì¼(.env) ìƒì„± (Secretsì—ì„œ ê°€ì ¸ì˜´)
            echo "${{ secrets.ENV_FILE }}" > .env
            
            # 2. ë„¤íŠ¸ì›Œí¬ ìƒì„± (í˜¹ì‹œ ì—†ìœ¼ë©´ ì—ëŸ¬ ë°©ì§€ìš©)
            docker network create npm_network || true
            
            # 3. ìµœì‹  ë°±ì—”ë“œ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ (DB ì´ë¯¸ì§€ëŠ” ì´ë¯¸ ìˆìœ¼ë©´ íŒ¨ìŠ¤ë¨)
            docker pull ${{ secrets.DOCKER_USERNAME }}/todac-backend:latest
            
            # 4. ì „ì²´ ì„œë¹„ìŠ¤ ì‹¤í–‰ (FastAPI + Postgres + Milvus ë“±)
            # --build: ì´ë¯¸ì§€ê°€ ë°”ë€Œì—ˆìœ¼ë©´ ìƒˆë¡œ ë§Œë“¦
            # -d: ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰
            docker compose up -d --remove-orphans
            
            # 5. ë¶ˆí•„ìš”í•œ ì´ë¯¸ì§€ ì •ë¦¬
            docker image prune -f
            
            echo "âœ… ëª¨ë“  ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ë°°í¬ ì™„ë£Œ!"