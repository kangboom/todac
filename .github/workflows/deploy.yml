name: Backend Auto Deploy (FastAPI + DBs)

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: Checkout Code
        uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 2. Docker Hub ë¡œê·¸ì¸
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 3. FastAPI ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      # (DBë‚˜ MilvusëŠ” ê³µì‹ ì´ë¯¸ì§€ë¥¼ ì“°ë¯€ë¡œ ë¹Œë“œí•  í•„ìš” ì—†ìŒ)
      - name: Build and Push Backend Image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          # â˜… docker-compose.ymlì— ì ì€ image ì´ë¦„ê³¼ ë˜‘ê°™ì´!
          tags: ${{ secrets.DOCKER_USERNAME }}/todac-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      # 4. docker-compose.yml íŒŒì¼ ì„œë²„ë¡œ ë°°ë‹¬
      - name: Copy docker-compose files to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          # â˜… docker-compose.prod.ymlë„ ê°™ì´ ì „ì†¡
          source: "docker-compose.yml,docker-compose.prod.yml"
          target: "~/backend"

      # 5. ì„œë²„ ì ‘ì† ë° ë°°í¬ ì‹¤í–‰
      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          # íƒ€ì„ì•„ì›ƒ ë„‰ë„‰í•˜ê²Œ
          timeout: 40s
          command_timeout: 30m
          
          script: |
            echo "ğŸš§ ë°±ì—”ë“œ ë°°í¬ ì‹œì‘..."
            
            # Docker Hub ë¡œê·¸ì¸
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
            
            cd ~/backend
            
            # .env íŒŒì¼ ìƒì„±
            echo "${{ secrets.ENV_FILE }}" > .env
            
            # ë„¤íŠ¸ì›Œí¬ ìƒì„± (ì—†ìœ¼ë©´ ìƒì„±)
            docker network create npm_network || true
            
            # ìµœì‹  ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
            docker pull ${{ secrets.DOCKER_USERNAME }}/todac-backend:latest
            
            # ë°°í¬ìš© ì„¤ì • ì ìš©í•˜ì—¬ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            # docker-compose.yml (ê¸°ë³¸) + docker-compose.prod.yml (ë°°í¬ ì„¤ì •)
            docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --remove-orphans
            
            # ë’·ì •ë¦¬
            docker image prune -f
            echo "âœ… ë°±ì—”ë“œ ë°°í¬ ì™„ë£Œ!"