name: Backend Auto Deploy (FastAPI + DBs)

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: Checkout Code
        uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 2. Docker Hub ë¡œê·¸ì¸
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 3. FastAPI ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      # (DBë‚˜ MilvusëŠ” ê³µì‹ ì´ë¯¸ì§€ë¥¼ ì“°ë¯€ë¡œ ë¹Œë“œí•  í•„ìš” ì—†ìŒ)
      - name: Build and Push Backend Image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          # â˜… docker-compose.ymlì— ì ì€ image ì´ë¦„ê³¼ ë˜‘ê°™ì´!
          tags: ${{ secrets.DOCKER_USERNAME }}/todac-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      # 4. docker-compose.yml íŒŒì¼ ì„œë²„ë¡œ ë°°ë‹¬
      - name: Copy docker-compose to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          source: "docker-compose.yml"
          target: "~/backend" # ë°±ì—”ë“œ ì „ìš© í´ë”

      # 5. ì„œë²„ ì ‘ì† ë° ë°°í¬ ì‹¤í–‰
      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          # íƒ€ì„ì•„ì›ƒ ë„‰ë„‰í•˜ê²Œ (ì•„ê¹Œ ì„¤ì •í•˜ì‹  ê²ƒ)
          timeout: 40s
          command_timeout: 30m
          
          # â–¼â–¼â–¼ ì—¬ê¸°ë¶€í„° ìˆ˜ì •í•˜ì„¸ìš”! â–¼â–¼â–¼
          script: |
            echo "ğŸš§ ë°±ì—”ë“œ ë°°í¬ ì‹œì‘..."
            
            # 1. [ì¤‘ìš”] ì„œë²„ì—ì„œë„ Docker Hub ë¡œê·¸ì¸ (ë¹„ê³µê°œ ì´ë¯¸ì§€ ì ‘ê·¼ ê¶Œí•œ íšë“)
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
            
            mkdir -p ~/backend
            cd ~/backend
            
            # .env íŒŒì¼ ìƒì„±
            echo "${{ secrets.ENV_FILE }}" > .env
            
            # ë„¤íŠ¸ì›Œí¬ ìƒì„±
            docker network create npm_network || true
            
            # 2. ìµœì‹  ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
            docker pull ${{ secrets.DOCKER_USERNAME }}/todac-backend:latest
            
            # 3. ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (â˜… --build ì˜µì…˜ ì œê±°!)
            # ì†ŒìŠ¤ì½”ë“œê°€ ì—†ìœ¼ë¯€ë¡œ ì„œë²„ì—ì„œ ë¹Œë“œí•˜ë©´ ì•ˆ ë©ë‹ˆë‹¤. ì˜¤ì§ ì´ë¯¸ì§€ë§Œ ê°ˆì•„ë¼ì›ë‹ˆë‹¤.
            docker compose up -d --remove-orphans
            
            # 4. ë’·ì •ë¦¬
            docker image prune -f
            echo "âœ… ë°±ì—”ë“œ ë°°í¬ ì™„ë£Œ!"